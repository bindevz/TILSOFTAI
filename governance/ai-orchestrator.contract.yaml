meta:
  project_name: TILSOFTAI
  purpose: Internal Enterprise AI Orchestrator
  target_runtime: .NET 8
  audience: Enterprise internal users only
  modification_policy: modify_existing_code_only

core_goal:
  description: >
    Build a production-grade internal AI system where C# (.NET 8)
    acts as the authoritative middleware that understands user intent,
    normalizes business context, executes ERP-safe logic, and controls
    all side effects. LLM is strictly a reasoning component.

authority_model:
  execution_owner: CSharp
  reasoning_owner: LLM
  fail_strategy: fail_closed

llm_contract:
  allowed_capabilities:
    - understand_natural_language
    - select_single_whitelisted_tool
    - return_strict_structured_json

  forbidden_capabilities:
    - generate_sql
    - access_database
    - infer_database_schema
    - execute_business_logic
    - perform_side_effects
    - explain_results
    - ask_followup_questions

  response_format:
    type: object
    required_fields:
      - tool
      - arguments
    additional_fields_allowed: false

  invalid_response_policy:
    on_parse_error: reject_and_stop
    on_schema_violation: reject_and_stop
    on_unknown_tool: reject_and_stop

system_prompt:
  enforced: true
  content: |
    You are an enterprise AI assistant.
    You must return ONLY valid JSON.
    You must use predefined tools only.
    You must NEVER generate SQL.
    You must NEVER explain anything.
    Default to tool `atomic.query.execute` for SQL-backed data retrieval. Do NOT use `models.search` (removed).
    If the request is unclear, choose the closest matching tool.

solution_structure:
  src:
    TILSOFTAI.Api:
      responsibility:
        - expose_openai_compatible_api
        - apply_cross_cutting_middleware
      must_not:
        - contain_business_logic
        - call_database_directly

    TILSOFTAI.Orchestration:
      responsibility:
        - chat_orchestration_pipeline
        - llm_interaction
        - tool_selection_and_dispatch
        - context_management
      must_not:
        - contain_domain_rules
        - contain_sql_or_ef_queries

    TILSOFTAI.Application:
      responsibility:
        - application_use_cases
        - business_validation
        - transactional_boundaries
      must_not:
        - depend_on_llm
        - expose_entities_to_api

    TILSOFTAI.Domain:
      responsibility:
        - core_business_concepts
        - value_objects
        - domain_interfaces
      must_not:
        - reference_infrastructure
        - contain_ai_logic

    TILSOFTAI.Infrastructure:
      responsibility:
        - sql_server_integration
        - ef_core_configuration
        - repositories
        - caching
        - logging
      must_not:
        - contain_ai_orchestration

orchestration_pipeline:
  ordered_steps:
    - receive_user_input
    - inject_system_prompt
    - call_llm
    - strict_json_parsing
    - tool_whitelist_validation
    - json_schema_validation
    - rbac_validation
    - business_context_normalization
    - application_service_execution
    - audit_logging
    - response_mapping

  stop_on_failure: true

tooling_model:
  definition:
    tool_is: business_capability
    not_allowed: crud_wrapper

  registry_rules:
    whitelist_only: true
    dynamic_registration: false

  tool_metadata:
    required:
      - name
      - read_only
      - required_roles
      - json_schema

business_context_normalization:
  ownership: CSharp
  llm_role: none

  examples:
    season:
      input_variants: ["24/25", "2024-2025"]
      normalized_to: SeasonCode

    metric:
      input_variants: ["PI", "PerformanceIndex"]
      normalized_to: MetricCode

  implementation_requirements:
    - semantic_resolver
    - domain_value_objects
    - deterministic_mapping_only

data_access_policy:
  database: sql_server
  orm: ef_core

  ai_data_access:
    allowed: false

  read_operations:
    must:
      - tenant_scoped
      - user_scoped
      - time_scoped
      - paginated
      - aggregated_for_summary

  write_operations:
    must:
      - transactional
      - business_validated
      - auditable
      - rbac_enforced

large_data_strategy:
  default:
    executor: CSharp
    approach: pre_aggregation

  chunking:
    enabled: true
    style: map_reduce
    ai_visibility: summarized_only

  token_budget:
    enforced: true
    overflow_policy: reject_request

security_and_governance:
  rbac:
    level: tool
    enforced_before_execution: true

  audit_logging:
    required_fields:
      - user_input
      - ai_raw_output
      - tool_executed
      - normalized_arguments
      - execution_result

  rate_limiting:
    enabled: true

  correlation_id:
    enabled: true

mandatory_examples:
  must_implement:
    - orders.query
    - orders.summary
    - customers.updateEmail

  implementation_rules:
    - no_todo
    - no_placeholder_logic
    - production_quality_only

codex_execution_guidelines:
  read_this_file_first: true

  allowed_actions:
    - refactor_existing_files
    - add_new_files_if_required

  forbidden_actions:
    - redesign_architecture
    - remove_existing_layers
    - weaken_security_rules
    - change_llm_contract

  output_rules:
    - no_explanation
    - no_summary
    - code_only
